@model WbtWebJob.Models.CustomJob

@{
    ViewData["Title"] = "编辑定制任务";
}

<div class="row mb-4">
    <div class="col">
        <h2>
            <i class="bi bi-pencil"></i> 编辑定制任务
        </h2>
    </div>
    <div class="col text-end">
        <a href="@Url.Action("Index")" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 返回列表
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form asp-action="Edit" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="CustomJobId" />
            <input type="hidden" asp-for="CreatedAt" />

            <div class="row">
                <!-- 基本信息 -->
                <div class="col-md-6">
                    <h5 class="mb-3">基本信息</h5>

                    <div class="mb-3">
                        <label asp-for="JobType" class="form-label">
                            任务类型 <span class="text-danger">*</span>
                        </label>
                        <input asp-for="JobType" class="form-control" placeholder="例如: DataSync, EmailSender" required />
                        <span asp-validation-for="JobType" class="text-danger"></span>
                        <small class="text-muted">用于标识任务的唯一类型，建议使用英文</small>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Name" class="form-label">
                            任务名称 <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Name" class="form-control" placeholder="例如: 数据同步任务" required />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">任务描述</label>
                        <textarea asp-for="Description" class="form-control" rows="3" placeholder="描述任务的用途和功能"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                            <label asp-for="IsActive" class="form-check-label">启用任务</label>
                        </div>
                    </div>
                </div>

                <!-- HTTP 配置 -->
                <div class="col-md-6">
                    <h5 class="mb-3">HTTP 配置</h5>

                    <div class="mb-3">
                        <label asp-for="HttpUrl" class="form-label">
                            HTTP URL <span class="text-danger">*</span>
                        </label>
                        <input asp-for="HttpUrl" class="form-control" type="url" placeholder="https://api.example.com/endpoint" required />
                        <span asp-validation-for="HttpUrl" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="HttpMethod" class="form-label">
                            HTTP 方法 <span class="text-danger">*</span>
                        </label>
                        <select asp-for="HttpMethod" class="form-select" required>
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                        <span asp-validation-for="HttpMethod" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="AuthType" class="form-label">认证类型</label>
                        <select asp-for="AuthType" class="form-select">
                            <option value="">无</option>
                            <option value="Basic">Basic Auth</option>
                            <option value="Bearer">Bearer Token</option>
                            <option value="ApiKey">API Key</option>
                        </select>
                        <span asp-validation-for="AuthType" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="AuthConfig" class="form-label">认证配置 (JSON)</label>
                        <textarea asp-for="AuthConfig" class="form-control" rows="3" placeholder='{"username": "user", "password": "pass"}'></textarea>
                        <span asp-validation-for="AuthConfig" class="text-danger"></span>
                        <small class="text-muted">JSON格式的认证配置信息</small>
                    </div>
                </div>
            </div>

            <!-- 高级配置 -->
            <div class="row mt-3">
                <div class="col-12">
                    <h5 class="mb-3">高级配置</h5>

                    <div class="mb-3">
                        <label asp-for="Headers" class="form-label">HTTP Headers (JSON)</label>
                        <textarea asp-for="Headers" class="form-control" rows="3" placeholder='{"Content-Type": "application/json", "X-Custom-Header": "value"}'></textarea>
                        <span asp-validation-for="Headers" class="text-danger"></span>
                        <small class="text-muted">自定义HTTP请求头，JSON格式</small>
                    </div>

                    <div class="mb-3">
                        <label asp-for="DefaultParameters" class="form-label">默认参数 (JSON)</label>
                        <textarea asp-for="DefaultParameters" class="form-control" rows="3" placeholder='{"param1": "value1", "param2": "value2"}'></textarea>
                        <span asp-validation-for="DefaultParameters" class="text-danger"></span>
                        <small class="text-muted">任务执行时的默认参数，JSON格式</small>
                    </div>
                </div>
            </div>

            <!-- 定时调度配置 -->
            <div class="row mt-3">
                <div class="col-12">
                    <h5 class="mb-3">
                        <i class="bi bi-clock-history"></i> 定时调度配置（可选）
                    </h5>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input asp-for="EnableSchedule" class="form-check-input" type="checkbox" id="enableScheduleSwitch" />
                            <label asp-for="EnableSchedule" class="form-check-label">
                                <strong>启用定时调度</strong>
                            </label>
                        </div>
                        <small class="text-muted">开启后任务将按照Cron表达式定时自动执行</small>
                    </div>

                    <div id="cronConfigSection" style="display: none;">
                        <div class="mb-3">
                            <label asp-for="CronExpression" class="form-label">Cron表达式</label>
                            <input asp-for="CronExpression" class="form-control font-monospace" placeholder="0 * * * *" id="cronExpressionInput" />
                            <span asp-validation-for="CronExpression" class="text-danger"></span>
                            <small class="text-muted">格式: 分钟 小时 日 月 周 (例如: 0 * * * * 表示每小时执行)</small>
                        </div>

                        <div class="alert alert-info">
                            <strong><i class="bi bi-lightbulb"></i> 常用Cron表达式示例：</strong>
                            <ul class="mb-0 mt-2 small">
                                <li><code>0 * * * *</code> - 每小时执行一次</li>
                                <li><code>0 0 * * *</code> - 每天午夜执行</li>
                                <li><code>0 9 * * *</code> - 每天上午9点执行</li>
                                <li><code>0 0 * * 1</code> - 每周一午夜执行</li>
                                <li><code>0 0 1 * *</code> - 每月1号午夜执行</li>
                                <li><code>*/5 * * * *</code> - 每5分钟执行一次</li>
                                <li><code>0 */2 * * *</code> - 每2小时执行一次</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        创建时间: @Model.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                        @if (Model.UpdatedAt.HasValue)
                        {
                            <span class="ms-3">最后更新: @Model.UpdatedAt.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</span>
                        }
                    </div>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> 保存更改
                    </button>
                    <a href="@Url.Action("Details", new { id = Model.CustomJobId })" class="btn btn-info">
                        <i class="bi bi-eye"></i> 查看详情
                    </a>
                    <a href="@Url.Action("Index")" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> 取消
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function() {
            // JSON 格式验证
            $('textarea[id$="AuthConfig"], textarea[id$="Headers"], textarea[id$="DefaultParameters"]').on('blur', function() {
                const value = $(this).val().trim();
                if (value && value !== '') {
                    try {
                        JSON.parse(value);
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    } catch (e) {
                        $(this).removeClass('is-valid').addClass('is-invalid');
                        alert('JSON 格式错误: ' + e.message);
                    }
                } else {
                    $(this).removeClass('is-invalid is-valid');
                }
            });

            // 定时调度开关
            $('#enableScheduleSwitch').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#cronConfigSection').slideDown();
                } else {
                    $('#cronConfigSection').slideUp();
                    $('#cronExpressionInput').val('');
                }
            }).trigger('change');
        });
    </script>
}
