@model WbtWebJob.Models.CustomJob
@{
    ViewData["Title"] = Model?.CustomJobId != Guid.Empty ? "编辑工作流" : "创建工作流";
    var isEdit = Model?.CustomJobId != Guid.Empty;
}

<div class="container-fluid mt-4">
    <!-- 顶部统一工具栏 -->
    <div class="editor-main-toolbar">
        <!-- 文件操作组 -->
        <div class="toolbar-group">
            <button type="button" class="btn btn-sm btn-primary" id="saveWorkflowBtn" title="保存工作流">
                <i class="bi bi-save"></i> 保存
            </button>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="导出">
                    <i class="bi bi-download"></i> 导出
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" id="exportJsonBtn"><i class="bi bi-filetype-json"></i> 导出JSON</a></li>
                    <li><a class="dropdown-item" href="#" id="exportPngBtn"><i class="bi bi-file-image"></i> 导出PNG</a></li>
                    <li><a class="dropdown-item" href="#" id="exportSvgBtn"><i class="bi bi-file-earmark-code"></i> 导出SVG</a></li>
                </ul>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="importJsonBtn" title="导入JSON">
                <i class="bi bi-upload"></i> 导入
            </button>
            <input type="file" id="importJsonFileInput" accept=".json" style="display: none;" />
            <a asp-action="Index" class="btn btn-sm btn-outline-secondary" title="返回列表">
                <i class="bi bi-arrow-left"></i>
            </a>
        </div>

        <div class="toolbar-divider"></div>

        <!-- 编辑操作组 -->
        <div class="toolbar-group">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="undoBtn" title="撤销">
                <i class="bi bi-arrow-counterclockwise"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="redoBtn" title="重做">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="deleteSelectedBtn" title="删除选中">
                <i class="bi bi-trash"></i>
            </button>
        </div>

        <div class="toolbar-divider"></div>

        <!-- 视图控制组 -->
        <div class="toolbar-group">
            <button class="btn btn-sm btn-outline-secondary" id="zoomInBtn" title="放大">
                <i class="bi bi-zoom-in"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="zoomOutBtn" title="缩小">
                <i class="bi bi-zoom-out"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="fitToScreenBtn" title="适应屏幕">
                <i class="bi bi-aspect-ratio"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="centerCanvasBtn" title="居中">
                <i class="bi bi-bullseye"></i>
            </button>
            <span class="zoom-level" id="zoomLevel">100%</span>
        </div>

        <div class="toolbar-divider"></div>

        <!-- 布局工具组 -->
        <div class="toolbar-group">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="autoLayoutBtn" title="自动布局">
                <i class="bi bi-diagram-3"></i> 自动布局
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="createGroupBtn" title="创建分组">
                <i class="bi bi-collection"></i> 分组
            </button>
        </div>

        <div class="toolbar-divider"></div>

        <!-- 连接线样式 -->
        <div class="toolbar-group">
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="连接线样式">
                    <i class="bi bi-bezier2"></i> <span id="edgeTypeLabel">折线</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item edge-type-option" href="#" data-edge-type="polyline">折线</a></li>
                    <li><a class="dropdown-item edge-type-option" href="#" data-edge-type="bezier">贝塞尔曲线</a></li>
                    <li><a class="dropdown-item edge-type-option" href="#" data-edge-type="line">直线</a></li>
                </ul>
            </div>
        </div>

        <!-- 右侧面板控制组 -->
        <div class="toolbar-group ms-auto">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleLeftPanelBtn" title="切换工具箱">
                <i class="bi bi-layout-sidebar"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleRightPanelBtn" title="切换属性面板">
                <i class="bi bi-layout-sidebar-reverse"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleMiniMapBtn" title="切换小地图">
                <i class="bi bi-map"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleFullscreenBtn" title="全屏">
                <i class="bi bi-arrows-fullscreen"></i>
            </button>
        </div>
    </div>

    <!-- 三栏布局 -->
    <div class="workflow-editor-container" id="workflowEditorContainer">
        <!-- 左侧工具栏 -->
        <div class="workflow-left-panel" id="leftPanel">
            <div class="panel-header">
                <h5>组件工具箱</h5>
            </div>
            <div class="panel-body">
                <!-- 操作组 -->
                <div class="component-group">
                    <div class="group-title">操作工具</div>
                    <div class="component-item" data-node-type="select" data-category="action">
                        <i class="bi bi-cursor"></i>
                        <span>选择</span>
                    </div>
                    <div class="component-item" data-node-type="connect" data-category="action">
                        <i class="bi bi-diagram-3"></i>
                        <span>连接</span>
                    </div>
                </div>

                <!-- 输入组 -->
                <div class="component-group">
                    <div class="group-title">输入节点</div>
                    <div class="component-item draggable" data-node-type="start" data-category="input">
                        <i class="bi bi-play-circle-fill"></i>
                        <span>开始</span>
                    </div>
                    <div class="component-item draggable" data-node-type="trigger" data-category="input">
                        <i class="bi bi-alarm"></i>
                        <span>触发器</span>
                    </div>
                    <div class="component-item draggable" data-node-type="event" data-category="input">
                        <i class="bi bi-bell-fill"></i>
                        <span>事件</span>
                    </div>
                </div>

                <!-- 处理组 -->
                <div class="component-group">
                    <div class="group-title">处理节点</div>
                    <div class="component-item draggable" data-node-type="httpAuth" data-category="process">
                        <i class="bi bi-key-fill"></i>
                        <span>HTTP授权</span>
                    </div>
                    <div class="component-item draggable" data-node-type="httpAction" data-category="process">
                        <i class="bi bi-arrow-left-right"></i>
                        <span>HTTP处理</span>
                    </div>
                    <div class="component-item draggable" data-node-type="commandLine" data-category="process">
                        <i class="bi bi-terminal-fill"></i>
                        <span>命令行</span>
                    </div>
                    <div class="component-item draggable" data-node-type="condition" data-category="process">
                        <i class="bi bi-question-diamond-fill"></i>
                        <span>条件判断</span>
                    </div>
                </div>

                <!-- 终止组 -->
                <div class="component-group">
                    <div class="group-title">终止节点</div>
                    <div class="component-item draggable" data-node-type="end" data-category="terminate">
                        <i class="bi bi-stop-circle-fill"></i>
                        <span>结束</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 中间画布 -->
        <div class="workflow-center-panel" id="centerPanel">
            <div id="workflowCanvas"></div>
            <!-- 小地图容器 -->
            <div class="minimap-container" id="minimapContainer" style="display: none;"></div>
        </div>

        <!-- 右侧属性面板 -->
        <div class="workflow-right-panel" id="rightPanel">
            <div class="panel-header">
                <h5>属性编辑器</h5>
            </div>
            <div class="panel-body" id="propertiesPanel">
                <div class="no-selection-message">
                    <i class="bi bi-info-circle"></i>
                    <p>请选择一个节点以编辑其属性</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 状态栏 -->
    <div class="workflow-status-bar" id="statusBar">
        <div class="status-item">
            <i class="bi bi-info-circle"></i>
            <span id="statusMessage">就绪</span>
        </div>
        <div class="status-item">
            <i class="bi bi-diagram-3"></i>
            <span id="nodeCount">节点: 0</span>
        </div>
        <div class="status-item">
            <i class="bi bi-arrow-left-right"></i>
            <span id="edgeCount">连接: 0</span>
        </div>
        <div class="status-item status-validation" id="validationStatus">
            <i class="bi bi-check-circle-fill text-success"></i>
            <span>DAG验证: 通过</span>
        </div>
    </div>
</div>

<!-- 保存工作流模态框 -->
<div class="modal fade" id="saveWorkflowModal" tabindex="-1" aria-labelledby="saveWorkflowModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveWorkflowModalLabel">保存工作流</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="workflowName" class="form-label">工作流名称 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="workflowName"
                           value="@Model?.Name" placeholder="请输入工作流名称" required>
                </div>
                <div class="mb-3">
                    <label for="workflowJobType" class="form-label">任务类型 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="workflowJobType"
                           value="@Model?.JobType" placeholder="请输入任务类型标识" required>
                </div>
                <div class="mb-3">
                    <label for="workflowDescription" class="form-label">描述</label>
                    <textarea class="form-control" id="workflowDescription" rows="3"
                              placeholder="请输入工作流描述">@Model?.Description</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmSaveBtn">保存</button>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="customJobId" value="@Model?.CustomJobId" />


@section Styles {
    <link rel="stylesheet" href="~/css/workflow-editor.css" />
    <link href="~/lib/logicflow/index.min.css" rel="stylesheet" />
    <link href="~/lib/logicflow/extension/index.min.css" rel="stylesheet" />
}

@section Scripts {    
    <script src="~/lib/logicflow/extension/index.min.js" defer></script>

    <script src="~/js/workflow-editor.js" defer></script>
}