@model IEnumerable<WbtWebJob.Models.Workflow>

@{
    ViewData["Title"] = "DAG工作流管理";
}

<div class="row mb-4">
    <div class="col">
        <h2>
            <i class="bi bi-diagram-3"></i> DAG工作流管理
        </h2>
    </div>
    <div class="col text-end">
        <a href="@Url.Action("Editor")" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> 创建工作流
        </a>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="card">
    <div class="card-body">
        @if (!Model.Any())
        {
            <div class="text-center py-5 text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">暂无工作流，点击上方按钮创建一个吧！</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>工作流名称</th>
                            <th>描述</th>
                            <th>节点数</th>
                            <th>连接数</th>
                            <th>版本</th>
                            <th>状态</th>
                            <th>调度</th>
                            <th>创建时间</th>
                            <th style="width: 280px;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var workflow in Model)
                        {
                            <tr>
                                <td>
                                    <strong>@workflow.Name</strong>
                                </td>
                                <td>
                                    <small>@(workflow.Description ?? "-")</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">@workflow.Nodes.Count</span>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">@workflow.Edges.Count</span>
                                </td>
                                <td>
                                    <small>v@workflow.Version</small>
                                </td>
                                <td>
                                    @if (workflow.IsActive)
                                    {
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> 启用
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-pause-circle"></i> 禁用
                                        </span>
                                    }
                                </td>
                                <td>
                                    @if (workflow.EnableSchedule)
                                    {
                                        <span class="badge bg-primary" title="@workflow.CronExpression">
                                            <i class="bi bi-clock"></i> 已调度
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">
                                            <i class="bi bi-dash"></i>
                                        </span>
                                    }
                                </td>
                                <td>
                                    <small>@workflow.CreatedAt.ToString("yyyy-MM-dd HH:mm")</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="@Url.Action("Editor", new { id = workflow.WorkflowId })"
                                           class="btn btn-outline-primary"
                                           title="编辑工作流">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="@Url.Action("Details", new { id = workflow.WorkflowId })"
                                           class="btn btn-outline-info"
                                           title="查看详情">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="@Url.Action("DownloadXml", new { id = workflow.WorkflowId })"
                                           class="btn btn-outline-success"
                                           title="下载XML">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <button class="btn btn-outline-warning toggle-active-btn"
                                                data-workflow-id="@workflow.WorkflowId"
                                                data-is-active="@workflow.IsActive.ToString().ToLower()"
                                                title="切换启用/禁用">
                                            <i class="bi bi-power"></i>
                                        </button>
                                        <button class="btn btn-outline-danger delete-btn"
                                                data-workflow-id="@workflow.WorkflowId"
                                                data-workflow-name="@workflow.Name"
                                                title="删除工作流">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // 切换启用/禁用
            $('.toggle-active-btn').on('click', function () {
                const workflowId = $(this).data('workflow-id');
                const isActive = $(this).data('is-active');
                const action = isActive ? '禁用' : '启用';

                if (confirm(`确定要${action}这个工作流吗？`)) {
                    $.ajax({
                        url: '@Url.Action("ToggleActive")/' + workflowId,
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                alert('操作失败: ' + response.message);
                            }
                        },
                        error: function (xhr) {
                            alert('操作失败: ' + xhr.responseText);
                        }
                    });
                }
            });

            // 删除工作流
            $('.delete-btn').on('click', function () {
                const workflowId = $(this).data('workflow-id');
                const workflowName = $(this).data('workflow-name');

                if (confirm(`确定要删除工作流"${workflowName}"吗？此操作不可恢复！`)) {
                    const form = $('<form></form>');
                    form.attr('method', 'POST');
                    form.attr('action', '@Url.Action("Delete")/' + workflowId);
                    form.append('<input type="hidden" name="__RequestVerificationToken" value="' +
                                $('input[name="__RequestVerificationToken"]').val() + '">');
                    $(document.body).append(form);
                    form.submit();
                }
            });
        });
    </script>
}
